"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.enablePlugin=enablePlugin;exports["default"]=sneakpeek;var _video=_interopRequireDefault(require("video.js"));var _window=_interopRequireDefault(require("global/window"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _extends(){_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r){if(Object.prototype.hasOwnProperty.call(r,n)){e[n]=r[n]}}}return e};return _extends.apply(this,arguments)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function _iterableToArrayLimit(e,t){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(e)))return;var r=[];var n=true;var a=false;var o=undefined;try{for(var i=e[Symbol.iterator](),u;!(n=(u=i.next()).done);n=true){r.push(u.value);if(t&&r.length===t)break}}catch(e){a=true;o=e}finally{try{if(!n&&i["return"]!=null)i["return"]()}finally{if(a)throw o}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}var defaults={width:0,height:0,basePath:"",urlParams:{}};function enablePlugin(e,t){var r=_video["default"].registerPlugin||_video["default"].plugin;r(e,t)}function getComputedStyle(e,t){return function(r){if(_window["default"].getComputedStyle){return _window["default"].getComputedStyle(e,t)[r]}return e.currentStyle[r]}}function offsetParent(e){if(e.nodeName!=="HTML"&&getComputedStyle(e)("position")==="static"){return offsetParent(e.offsetParent)}return e}function getScrollOffset(){if(_window["default"].pageXOffset){return{x:_window["default"].pageXOffset,y:_window["default"].pageYOffset}}return{x:document.documentElement.scrollLeft,y:document.documentElement.scrollTop}}function parseParams(e){var t=Object.entries(e).map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1];return"".concat(r,"=").concat(n)}).join("&");if(t!==""){return"?".concat(t)}return""}function parseImageLink(e){var t=e.indexOf("#");if(t===-1){return{src:e,x:0,y:0,w:0,h:0}}var r=e.substring(0,t);var n=e.substring(t+1);if(n.substring(0,5)!=="xywh="){return{src:defaults.basePath+r,x:0,y:0,w:0,h:0}}var a=n.substring(5).split(",");return{src:defaults.basePath+r,x:+a[0],y:+a[1],w:+a[2],h:+a[3]}}function sneakpeek(e){defaults.basePath=e.basePath||defaults.basePath;var t=_extends({},defaults,e);var r=this;var n=[],a;r.ready(function(){n=r.remoteTextTracks();o();if(!a){n.addEventListener("addtrack",o)}});function o(){if(a){return}for(var e=0;e<n.length;e++){if(n[e].kind==="metadata"&&n[e].label==="sneakpeek"){a=n[e];a.mode="hidden";break}}if(!a){return}if(navigator.userAgent.toLowerCase().indexOf("android")!==-1){var o=r.controlBar.progressControl;var i=function e(){o.addClass("fake-active")};var u=function e(){o.removeClass("fake-active")};o.on("touchstart",i);o.on("touchend",u);o.on("touchcancel",u)}var s=document.createElement("div");s.className="vjs-sneakpeek-holder";var l=document.createElement("img");s.appendChild(l);l.className="vjs-sneakpeek";var c=r.duration();r.on("durationchange",function(){c=r.duration()});r.on("loadedmetadata",function(){c=r.duration()});var f=r.controlBar.progressControl;f.el().appendChild(s);function d(e){var n=getScrollOffset().x;var o=offsetParent(f.el()).getBoundingClientRect();var i=e.pageX;if(e.changedTouches){i=e.changedTouches[0].pageX}var u=(o.width||o.right)+n;var d=i||e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;d-=offsetParent(f.el()).getBoundingClientRect().left+n;var p=Math.floor(d/f.width()*c);var h=a&&a.cues&&a.cues.length;var v=0;var y;while(v<h){var m=a.cues[v];if(m.startTime<=p&&m.endTime>=p){y=parseImageLink(m.text);break}v++}if(typeof y==="undefined"){return}if(y.src&&l.src!==y.src){var g="";if(y.src[0]==="/"){g=r.currentSrc();g=g.substring(0,g.lastIndexOf("/"))}l.src=g+y.src+parseParams(t.urlParams)}y.w=y.w||t.width;y.h=y.h||t.height;if(s.style.width!==y.w||s.style.height!==y.h){s.style.width="".concat(y.w,"px");s.style.height="".concat(y.h,"px")}l.style.left="".concat(-y.x,"px");l.style.top="".concat(-y.y,"px");var b=[y.y,y.w+y.x,y.y+y.h,y.x];l.style.clip="rect(".concat(b.join("px,"),"px)");var w=y.w;var _=w/2;if(d+_>u){d=u-w}else if(d<_){d=0}else{d=d-_}s.style.left="".concat(d,"px")}function p(){s.style.left="-1000px"}f.on("mousemove",d);f.on("touchmove",d);f.on("mouseout",p);f.on("touchcancel",p);f.on("touchend",p);r.on("userinactive",p)}}