"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.enablePlugin=enablePlugin;exports["default"]=sneakpeek;var _video=_interopRequireDefault(require("video.js"));var _window=_interopRequireDefault(require("global/window"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _extends(){_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r){if(Object.prototype.hasOwnProperty.call(r,n)){e[n]=r[n]}}}return e};return _extends.apply(this,arguments)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(r);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++){n[r]=e[r]}return n}function _iterableToArrayLimit(e,t){if(typeof Symbol==="undefined"||!(Symbol.iterator in Object(e)))return;var r=[];var n=true;var a=false;var o=undefined;try{for(var i=e[Symbol.iterator](),u;!(n=(u=i.next()).done);n=true){r.push(u.value);if(t&&r.length===t)break}}catch(e){a=true;o=e}finally{try{if(!n&&i["return"]!=null)i["return"]()}finally{if(a)throw o}}return r}function _arrayWithHoles(e){if(Array.isArray(e))return e}var defaults={width:0,height:0,basePath:"",urlParams:{}};function enablePlugin(e,t){var r=_video["default"].registerPlugin||_video["default"].plugin;r(e,t)}function getComputedStyle(t,r){return function(e){if(_window["default"].getComputedStyle){return _window["default"].getComputedStyle(t,r)[e]}return t.currentStyle[e]}}function offsetParent(e){if(e.nodeName!=="HTML"&&getComputedStyle(e)("position")==="static"){return offsetParent(e.offsetParent)}return e}function getScrollOffset(){if(_window["default"].pageXOffset){return{x:_window["default"].pageXOffset,y:_window["default"].pageYOffset}}return{x:document.documentElement.scrollLeft,y:document.documentElement.scrollTop}}function parseParams(e){var t=Object.entries(e).map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1];return"".concat(r,"=").concat(n)}).join("&");if(t!==""){return"?".concat(t)}return""}function parseImageLink(e){var t=e.indexOf("#");if(t===-1){return{src:e,x:0,y:0,w:0,h:0}}var r=e.substring(0,t);var n=e.substring(t+1);if(n.substring(0,5)!=="xywh="){return{src:defaults.basePath+r,x:0,y:0,w:0,h:0}}var a=n.substring(5).split(",");return{src:defaults.basePath+r,x:+a[0],y:+a[1],w:+a[2],h:+a[3]}}function sneakpeek(e){defaults.basePath=e.basePath||defaults.basePath;var b=_extends({},defaults,e);var w=this;var i=[],_;w.ready(function(){i=w.remoteTextTracks();t();if(!_){i.addEventListener("addtrack",t)}});function t(){if(_){return}for(var e=0;e<i.length;e++){if(i[e].kind==="metadata"&&i[e].label==="sneakpeek"){_=i[e];_.mode="hidden";break}}if(!_){return}if(navigator.userAgent.toLowerCase().indexOf("android")!==-1){var t=w.controlBar.progressControl;var r=function e(){t.addClass("fake-active")};var n=function e(){t.removeClass("fake-active")};t.on("touchstart",r);t.on("touchend",n);t.on("touchcancel",n)}var v=document.createElement("div");v.className="vjs-sneakpeek-holder";var y=document.createElement("img");v.appendChild(y);y.className="vjs-sneakpeek";var m=w.duration();w.on("durationchange",function(){m=w.duration()});w.on("loadedmetadata",function(){m=w.duration()});var g=w.controlBar.progressControl;g.el().appendChild(v);function a(e){var t=getScrollOffset().x;var r=offsetParent(g.el()).getBoundingClientRect();var n=e.pageX;if(e.changedTouches){n=e.changedTouches[0].pageX}var a=(r.width||r.right)+t;var o=n||e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;o-=offsetParent(g.el()).getBoundingClientRect().left+t;var i=Math.floor(o/g.width()*m);var u=_&&_.cues&&_.cues.length;var s=0;var l;while(s<u){var c=_.cues[s];if(c.startTime<=i&&c.endTime>=i){l=parseImageLink(c.text);break}s++}if(typeof l==="undefined"){return}if(l.src&&y.src!==l.src){var f="";if(l.src[0]==="/"){f=w.currentSrc();f=f.substring(0,f.lastIndexOf("/"))}y.src=f+l.src+parseParams(b.urlParams)}l.w=l.w||b.width;l.h=l.h||b.height;if(v.style.width!==l.w||v.style.height!==l.h){v.style.width="".concat(l.w,"px");v.style.height="".concat(l.h,"px")}y.style.left="".concat(-l.x,"px");y.style.top="".concat(-l.y,"px");var d=[l.y,l.w+l.x,l.y+l.h,l.x];y.style.clip="rect(".concat(d.join("px,"),"px)");var p=l.w;var h=p/2;if(o+h>a){o=a-p}else if(o<h){o=0}else{o=o-h}v.style.left="".concat(o,"px")}function o(){v.style.left="-1000px"}g.on("mousemove",a);g.on("touchmove",a);g.on("mouseout",o);g.on("touchcancel",o);g.on("touchend",o);w.on("userinactive",o)}}