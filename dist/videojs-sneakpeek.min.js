"use strict";Object.defineProperty(exports,"__esModule",{value:true});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r){if(Object.prototype.hasOwnProperty.call(r,n)){e[n]=r[n]}}}return e};var _slicedToArray=function(){function e(e,t){var r=[];var n=true;var a=false;var o=undefined;try{for(var i=e[Symbol.iterator](),u;!(n=(u=i.next()).done);n=true){r.push(u.value);if(t&&r.length===t)break}}catch(e){a=true;o=e}finally{try{if(!n&&i["return"])i["return"]()}finally{if(a)throw o}}return r}return function(t,r){if(Array.isArray(t)){return t}else if(Symbol.iterator in Object(t)){return e(t,r)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();exports.enablePlugin=enablePlugin;exports.default=sneakpeek;var _video=require("video.js");var _video2=_interopRequireDefault(_video);var _window=require("global/window");var _window2=_interopRequireDefault(_window);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var defaults={width:0,height:0,basePath:"",urlParams:{}};function enablePlugin(e,t){var r=_video2.default.registerPlugin||_video2.default.plugin;r(e,t)}function getComputedStyle(e,t){return function(r){if(_window2.default.getComputedStyle){return _window2.default.getComputedStyle(e,t)[r]}return e.currentStyle[r]}}function offsetParent(e){if(e.nodeName!=="HTML"&&getComputedStyle(e)("position")==="static"){return offsetParent(e.offsetParent)}return e}function getScrollOffset(){if(_window2.default.pageXOffset){return{x:_window2.default.pageXOffset,y:_window2.default.pageYOffset}}return{x:document.documentElement.scrollLeft,y:document.documentElement.scrollTop}}function parseParams(e){var t=Object.entries(e).map(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1];return r+"="+n}).join("&");if(t!==""){return"?"+t}return""}function parseImageLink(e){var t=e.indexOf("#");if(t===-1){return{src:e,x:0,y:0,w:0,h:0}}var r=e.substring(0,t);var n=e.substring(t+1);if(n.substring(0,5)!=="xywh="){return{src:defaults.basePath+r,x:0,y:0,w:0,h:0}}var a=n.substring(5).split(",");return{src:defaults.basePath+r,x:+a[0],y:+a[1],w:+a[2],h:+a[3]}}function sneakpeek(e){defaults.basePath=e.basePath||defaults.basePath;var t=_extends({},defaults,e);var r=this;var n=[],a=void 0;r.ready(function(){n=r.remoteTextTracks();o();if(!a){n.addEventListener("addtrack",o)}});function o(){if(a){return}for(var e=0;e<n.length;e++){if(n[e].kind==="metadata"&&n[e].label==="sneakpeek"){a=n[e];a.mode="hidden";break}}if(!a){return}if(navigator.userAgent.toLowerCase().indexOf("android")!==-1){var o=r.controlBar.progressControl;var i=function e(){o.addClass("fake-active")};var u=function e(){o.removeClass("fake-active")};o.on("touchstart",i);o.on("touchend",u);o.on("touchcancel",u)}var s=document.createElement("div");s.className="vjs-sneakpeek-holder";var l=document.createElement("img");s.appendChild(l);l.className="vjs-sneakpeek";var f=r.duration();r.on("durationchange",function(){f=r.duration()});r.on("loadedmetadata",function(){f=r.duration()});var d=r.controlBar.progressControl;d.el().appendChild(s);function c(e){var n=getScrollOffset().x;var o=offsetParent(d.el()).getBoundingClientRect();var i=e.pageX;if(e.changedTouches){i=e.changedTouches[0].pageX}var u=(o.width||o.right)+n;var c=i||e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;c-=offsetParent(d.el()).getBoundingClientRect().left+n;var v=Math.floor(c/d.width()*f);var h=a&&a.cues&&a.cues.length;var p=0;var g=void 0;while(p<h){var m=a.cues[p];if(m.startTime<=v&&m.endTime>=v){g=parseImageLink(m.text);break}p++}if(typeof g==="undefined"){return}if(g.src&&l.src!==g.src){var w="";if(g.src[0]==="/"){w=r.currentSrc();w=w.substring(0,w.lastIndexOf("/"))}l.src=w+g.src+parseParams(t.urlParams)}g.w=g.w||t.width;g.h=g.h||t.height;if(s.style.width!==g.w||s.style.height!==g.h){s.style.width=g.w+"px";s.style.height=g.h+"px"}l.style.left=-g.x+"px";l.style.top=-g.y+"px";var y=[g.y,g.w+g.x,g.y+g.h,g.x];l.style.clip="rect("+y.join("px,")+"px)";var x=g.w;var b=x/2;if(c+b>u){c=u-x}else if(c<b){c=0}else{c=c-b}s.style.left=c+"px"}function v(){s.style.left="-1000px"}d.on("mousemove",c);d.on("touchmove",c);d.on("mouseout",v);d.on("touchcancel",v);d.on("touchend",v);r.on("userinactive",v)}}